name: Build and Release Package

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag name for the release (e.g., v1.0.0)"
        required: true
      release_name:
        description: "Name of the release"
        required: true
      release_notes:
        description: "Release notes"
        required: true

jobs:
  build_and_package:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Install dependencies and build web-frontend
      - name: Install and Build Web Frontend
        working-directory: ./frontend
        run: |
          npm install
          npm run build

      # Step 3: Copy built frontend to docker/frontend
      - name: Copy Frontend Build
        run: |
          # Remove old build artifacts but keep .gitkeep and .env files
          find docker/frontend -mindepth 1 ! -name '.gitkeep' ! -name '.env' ! -name 'config.yaml' -delete
          cp -r frontend/dist/* docker/frontend/
          # Ensure config.yaml exists (copy from public if not)
          if [ ! -f docker/frontend/config.yaml ]; then
            cp frontend/public/config.yaml docker/frontend/
          fi

      # Step 4: Copy backend files to docker/backend
      - name: Copy Backend Files
        run: |
          # Remove old backend files but keep .gitkeep, .env, and uploads/
          find docker/backend -mindepth 1 -maxdepth 1 ! -name '.gitkeep' ! -name '.env' ! -name 'uploads' -delete
          cp backend/app.py docker/backend/
          cp backend/requirements.txt docker/backend/
          # Ensure uploads directory exists
          mkdir -p docker/backend/uploads

      # Step 4.5: Clean up backup files
      - name: Clean up backup files
        run: |
          find . -name "*.bak" -delete

      # Step 5: Remove source files and prepare release structure
      - name: Prepare Release Structure
        run: |
          mkdir clippy
          rm -rf backend/ frontend/ .github/ logo/ build.sh
          shopt -s extglob
          mv !(clippy) clippy/

      # Step 6: Package into ZIP
      - name: Create Release ZIP
        run: |
          zip -r release.zip clippy/*

      # Step 7: Create GitHub Release and Upload Asset
      - name: Create GitHub Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ github.event.inputs.tag_name }}
          name: ${{ github.event.inputs.release_name }}
          body: ${{ github.event.inputs.release_notes }}
          files: release.zip